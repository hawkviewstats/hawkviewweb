<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tamil Nadu Election Exit Poll | Hawkview</title>
  <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
  <link rel="stylesheet" href="poll.css">
  <script src="https://www.google.com/recaptcha/api.js?render=6Ld3BnUsAAAAAOFlxURTcfbTBGgW875Q8tByK9nM"></script>
  <style>
    .error { border: 2px solid red; }
    .error-text { color: red; font-weight: bold; }
  </style>
</head>
<body class="background-customizable">

<header class="banner-customizable">
  <h1 style="text-align:center; color:#f1f5f9;">Tamil Nadu Election Exit Poll</h1>
</header>

<main style="max-width:900px; margin:30px auto; padding:0 10px;">
  <form id="poll-form">

    <!-- Question 1 -->
    <section class="poll-card" id="q1-section">
      <label class="label-customizable">1. Which party do you think will win? <span class="error-text" id="q1-error"></span></label>
      <div class="options">
        <label><input type="radio" name="q1" value="DMK (M.K. Stalin)"> DMK (M.K. Stalin)</label><br>
        <label><input type="radio" name="q1" value="AIADMK (E.P.S)"> AIADMK (E.P.S)</label><br>
        <label><input type="radio" name="q1" value="TVK (Vijay)"> TVK (Vijay)</label><br>
        <label><input type="radio" name="q1" value="NTK (Seeman)"> NTK (Seeman)</label><br>
        <label>
          <input type="radio" name="q1" value="Others"> Others
          <input type="text" name="q1_others" placeholder="Please specify">
        </label>
      </div>
    </section>

    <!-- Question 2 -->
    <section class="poll-card" id="q2-section">
      <label class="label-customizable">2. Are you satisfied with the current government's performance? <span class="error-text" id="q2-error"></span></label>
      <div class="options">
        <label><input type="radio" name="q2" value="Very Satisfied"> Very Satisfied</label><br>
        <label><input type="radio" name="q2" value="Satisfied"> Satisfied</label><br>
        <label><input type="radio" name="q2" value="Neutral"> Neutral</label><br>
        <label><input type="radio" name="q2" value="Dissatisfied"> Dissatisfied</label>
      </div>
    </section>

    <!-- Question 3 -->
    <section class="poll-card" id="q3-section">
      <label class="label-customizable">3. Will Vijay be a defining factor in this election? <span class="error-text" id="q3-error"></span></label>
      <div class="options">
        <label><input type="radio" name="q3" value="Definitely Yes"> Definitely Yes</label><br>
        <label><input type="radio" name="q3" value="Probably Yes"> Probably Yes</label><br>
        <label><input type="radio" name="q3" value="Probably No"> Probably No</label><br>
        <label><input type="radio" name="q3" value="Definitely No"> Definitely No</label><br>
        <label><input type="radio" name="q3" value="Not Sure"> Not Sure</label>
      </div>
    </section>

    <!-- Question 4 -->
    <section class="poll-card" id="q4-section">
      <label class="label-customizable">4. Which factor will be most important in this election? <span class="error-text" id="q4-error"></span></label>
      <div class="options">
        <label><input type="radio" name="q4" value="Party Manifestos"> Party Manifestos</label><br>
        <label><input type="radio" name="q4" value="Women's Rights"> Women's Rights</label><br>
        <label><input type="radio" name="q4" value="Corruption"> Corruption</label><br>
        <label><input type="radio" name="q4" value="Political Alliances"> Political Alliances</label><br>
        <label><input type="radio" name="q4" value="CM Candidates"> C.M Candidates</label>
      </div>
    </section>

    <!-- Question 5 -->
    <section class="poll-card" id="q5-section">
      <label class="label-customizable">5. Which age group do you belong to? <span class="error-text" id="q5-error"></span></label>
      <div class="options">
        <label><input type="radio" name="q5" value="18–25"> 18–25</label><br>
        <label><input type="radio" name="q5" value="26–35"> 26–35</label><br>
        <label><input type="radio" name="q5" value="36–50"> 36–50</label><br>
        <label><input type="radio" name="q5" value="50+"> 50+</label>
      </div>
    </section>

    <!-- Question 6 -->
    <section class="poll-card" id="q6-section">
      <label class="label-customizable">6. Select your District and Constituency: <span class="error-text" id="q6-error"></span></label>
      <div class="options">
        <select id="district" name="district">
          <option value="">Select District</option>
          <option value="Chennai">Chennai</option>
          <option value="Coimbatore">Coimbatore</option>
          <option value="Madurai">Madurai</option>
          <option value="Salem">Salem</option>
          <option value="Tiruchirappalli">Tiruchirappalli</option>
          <option value="Tirunelveli">Tirunelveli</option>
          <option value="Erode">Erode</option>
          <option value="Vellore">Vellore</option>
          <option value="Thoothukudi">Thoothukudi</option>
          <option value="Tiruvallur">Tiruvallur</option>
          <option value="Thanjavur">Thanjavur</option>
          <option value="Dindigul">Dindigul</option>
          <option value="Nagapattinam">Nagapattinam</option>
          <option value="Krishnagiri">Krishnagiri</option>
          <option value="Kanchipuram">Kanchipuram</option>
        </select>

        <select id="constituency" name="constituency">
          <option value="">Select Constituency</option>
        </select>
      </div>
    </section>

    <button type="submit" class="submitButton-customizable">Submit Poll</button>
    <p id="status" style="margin-top:15px; font-weight:bold;"></p>

  </form>
</main>

<script>
  // District → Constituency mapping
  const districtMap = {
    "Chennai": ["Royapettah", "Velachery", "Anna Nagar", "Thousand Lights", "Egmore"],
    "Coimbatore": ["Thondamuthur", "Gandhipuram", "Sulur", "Coimbatore North", "Coimbatore South"],
    "Madurai": ["Madurai North", "Madurai South", "Thiruparankundram", "Melur", "Usilampatti"],
    "Salem": ["Salem North", "Salem South", "Omalur"],
    "Tiruchirappalli": ["Srirangam", "Manapparai", "Lalgudi", "Tiruchirappalli West"],
    "Tirunelveli": ["Palayamkottai", "Tirunelveli", "Ambasamudram"],
    "Erode": ["Erode East", "Erode West", "Perundurai"],
    "Vellore": ["Vellore", "Katpadi", "Gudiyatham"],
    "Thoothukudi": ["Thoothukudi", "Srivaikuntam", "Vilathikulam"],
    "Tiruvallur": ["Tiruvallur", "Ponneri", "Gummidipoondi"],
    "Thanjavur": ["Thanjavur", "Kumbakonam", "Papanasam"],
    "Dindigul": ["Dindigul", "Nilakottai", "Natham"],
    "Nagapattinam": ["Nagapattinam", "Kilvelur", "Vedaranyam"],
    "Krishnagiri": ["Krishnagiri", "Pochampalli", "Uthangarai"],
    "Kanchipuram": ["Kanchipuram", "Chengalpattu", "Sriperumbudur"]
  };

  const districtSelect = document.getElementById("district");
  const constituencySelect = document.getElementById("constituency");

  districtSelect.addEventListener("change", () => {
    const district = districtSelect.value;
    constituencySelect.innerHTML = '<option value="">Select Constituency</option>';
    if(districtMap[district]){
      districtMap[district].forEach(c => {
        const option = document.createElement("option");
        option.value = c;
        option.text = c;
        constituencySelect.add(option);
      });
    }
  });
</script>

<script>
  const form = document.getElementById("poll-form");
  const statusEl = document.getElementById("status");

  function validateForm() {
    let valid = true;
    document.querySelectorAll(".error-text").forEach(e => e.innerText="");
    document.querySelectorAll("section").forEach(sec => sec.classList.remove("error"));

    if(!form.q1.value || (form.q1.value==="Others" && !form.q1_others.value.trim())){
      valid=false;
      document.getElementById("q1-error").innerText=" *Required";
      document.getElementById("q1-section").classList.add("error");
    }
    if(!form.q2.value){ valid=false; document.getElementById("q2-error").innerText=" *Required"; document.getElementById("q2-section").classList.add("error"); }
    if(!form.q3.value){ valid=false; document.getElementById("q3-error").innerText=" *Required"; document.getElementById("q3-section").classList.add("error"); }
    if(!form.q4.value){ valid=false; document.getElementById("q4-error").innerText=" *Required"; document.getElementById("q4-section").classList.add("error"); }
    if(!form.q5.value){ valid=false; document.getElementById("q5-error").innerText=" *Required"; document.getElementById("q5-section").classList.add("error"); }
    if(!form.district.value || !form.constituency.value){ valid=false; document.getElementById("q6-error").innerText=" *Required"; document.getElementById("q6-section").classList.add("error"); }

    return valid;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault(); // correct: listen to form submit
    if(!validateForm()) return;

    const token = await grecaptcha.execute('6Ld3BnUsAAAAAOFlxURTcfbTBGgW875Q8tByK9nM', { action: 'submit_poll' });

    const data = {
      responseId: uuidv4(),
      q1: form.q1.value === "Others" ? form.q1_others.value : form.q1.value,
      q2: form.q2.value,
      q3: form.q3.value,
      q4: form.q4.value,
      q5: form.q5.value,
      district: form.district.value,
      constituency: form.constituency.value,
      timestamp: new Date().toISOString(),
      recaptchaToken: token
    };

    try {
      const response = await fetch("https://b2c3jc8q48.execute-api.us-east-1.amazonaws.com/production/submitPoll", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if(response.status===200){
        statusEl.style.color="green";
        statusEl.innerText="✅ Your poll entry has been successfully submitted!";
        form.reset();
        constituencySelect.innerHTML='<option value="">Select Constituency</option>';
      } else if(response.status===403){
        statusEl.style.color="red";
        statusEl.innerText="⚠ CAPTCHA verification failed. Please try again.";
      } else{
        statusEl.style.color="red";
        statusEl.innerText="⚠ Error submitting poll. Please try again.";
      }
    } catch(err){
      console.error(err);
      statusEl.style.color="red";
      statusEl.innerText="⚠ Network error. Please try again later.";
    }
  });
</script>
</body>
</html>
